name: publish
on:
  workflow_dispatch:
    inputs:
      terraform_version:
        description: "Terraform version to package (leave empty to use package.json version)"
        required: false
        type: string
  push:
    tags:
      - "v[0-9]*"

env:
  NODE_VERSION: "24"

jobs:
  # Extract version from git tag or input
  prepare:
    runs-on: ubuntu-latest
    outputs:
      terraform_version: ${{ steps.version.outputs.terraform_version }}
      package_version: ${{ steps.version.outputs.package_version }}
    steps:
      - uses: actions/checkout@v4
      - name: Determine versions
        id: version
        run: ./scripts/release/determine-versions.sh "${{ inputs.terraform_version }}" github

  # Build platform-specific packages first
  build-platform-packages:
    needs: [prepare]
    uses: ./.github/workflows/build-platform-packages.yml
    with:
      terraform_version: ${{ needs.prepare.outputs.terraform_version }}
    secrets:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

  # Build main package
  build:
    needs: [prepare]
    uses: ./.github/workflows/build.yml

  # Update main package with platform package versions and publish
  publish:
    needs: [build, build-platform-packages, prepare]
    environment: publish
    permissions:
      contents: write # release
      id-token: write # provenance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: "https://registry.npmjs.org"
          cache: "npm"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          artifact-ids: ${{ needs.build.outputs.artifact-id }}
          path: ./

      - name: Update optionalDependencies versions
        run: ./scripts/release/update-tarball-deps.sh ./artifacts/package.tgz "${{ needs.prepare.outputs.terraform_version }}"

      - name: Verify package integrity
        run: ./scripts/release/verify-package-integrity.sh ./artifacts/package.tgz "${{ needs.prepare.outputs.terraform_version }}"

      - name: Publish main package to npm
        run: ./scripts/release/publish-main-package.sh ./artifacts/package.tgz "${{ needs.prepare.outputs.package_version }}"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create GitHub release
        run: ./scripts/release/create-github-release.sh "${{ needs.prepare.outputs.package_version }}" "${{ needs.prepare.outputs.terraform_version }}" ./artifacts/package.tgz
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Release summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **Successfully released v${{ needs.prepare.outputs.package_version }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Package Version**: ${{ needs.prepare.outputs.package_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Terraform Version**: ${{ needs.prepare.outputs.terraform_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform Packages**: All 10 platform-specific packages published" >> $GITHUB_STEP_SUMMARY
          echo "- **Main Package**: Published with updated optionalDependencies" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHub Release**: Created with release notes and package attachment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Verify the release works across different platforms" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor npm download statistics" >> $GITHUB_STEP_SUMMARY
          echo "- Update documentation if needed" >> $GITHUB_STEP_SUMMARY
